<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cart Persistence Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      .add-btn {
        background-color: #28a745;
        color: white;
      }
      .clear-btn {
        background-color: #dc3545;
        color: white;
      }
      .test-btn {
        background-color: #007bff;
        color: white;
      }
    </style>
  </head>
  <body>
    <h1>üõí Cart Persistence Test</h1>
    <p>This page tests if cart persistence is working correctly.</p>

    <div class="test-section">
      <h3>Test 1: Add Items to Cart</h3>
      <button class="add-btn" onclick="addTestItem()">Add Test Item</button>
      <button class="add-btn" onclick="addAnotherItem()">
        Add Another Item
      </button>
      <div id="cart-display"></div>
    </div>

    <div class="test-section">
      <h3>Test 2: Cart Persistence</h3>
      <button class="test-btn" onclick="testPersistence()">
        Test Persistence
      </button>
      <div id="persistence-result"></div>
    </div>

    <div class="test-section">
      <h3>Test 3: Clear Cart</h3>
      <button class="clear-btn" onclick="clearCart()">Clear Cart</button>
      <div id="clear-result"></div>
    </div>

    <div class="test-section">
      <h3>Test 4: localStorage Inspection</h3>
      <button class="test-btn" onclick="inspectLocalStorage()">
        Inspect localStorage
      </button>
      <div id="storage-inspection"></div>
    </div>

    <script>
      // Simulate cart functionality
      let cart = [];

      // Load cart from localStorage on page load
      function loadCart() {
        try {
          const savedCart = localStorage.getItem('sandwich-shop-cart');
          if (savedCart) {
            cart = JSON.parse(savedCart);
            console.log('Cart loaded from localStorage:', cart);
            updateCartDisplay();
          }
        } catch (error) {
          console.error('Error loading cart:', error);
        }
      }

      // Save cart to localStorage
      function saveCart() {
        try {
          localStorage.setItem('sandwich-shop-cart', JSON.stringify(cart));
          console.log('Cart saved to localStorage:', cart);
        } catch (error) {
          console.error('Error saving cart:', error);
        }
      }

      // Add test item
      function addTestItem() {
        const item = {
          id: 'test-1',
          name: 'Test Sandwich',
          price: 8.99,
          quantity: 1,
          availableStock: 10,
          dropProductId: 'drop-1',
          productId: 'prod-1',
        };

        const existingItem = cart.find(i => i.id === item.id);
        if (existingItem) {
          existingItem.quantity += 1;
        } else {
          cart.push(item);
        }

        saveCart();
        updateCartDisplay();
      }

      // Add another test item
      function addAnotherItem() {
        const item = {
          id: 'test-2',
          name: 'Another Sandwich',
          price: 7.99,
          quantity: 1,
          availableStock: 5,
          dropProductId: 'drop-1',
          productId: 'prod-2',
        };

        const existingItem = cart.find(i => i.id === item.id);
        if (existingItem) {
          existingItem.quantity += 1;
        } else {
          cart.push(item);
        }

        saveCart();
        updateCartDisplay();
      }

      // Update cart display
      function updateCartDisplay() {
        const display = document.getElementById('cart-display');
        if (cart.length === 0) {
          display.innerHTML = '<p>Cart is empty</p>';
        } else {
          const total = cart.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0
          );
          display.innerHTML = `
                    <h4>Cart Items (${cart.length}):</h4>
                    ${cart
                      .map(
                        item => `
                        <div style="margin: 5px 0; padding: 5px; background: #f8f9fa;">
                            ${item.name} - Qty: ${item.quantity} - $${item.price.toFixed(2)}
                        </div>
                    `
                      )
                      .join('')}
                    <p><strong>Total: $${total.toFixed(2)}</strong></p>
                `;
        }
      }

      // Test persistence
      function testPersistence() {
        const result = document.getElementById('persistence-result');

        if (cart.length === 0) {
          result.innerHTML =
            '<p class="error">‚ùå Cart is empty. Add items first.</p>';
          return;
        }

        // Simulate page refresh by clearing cart array but keeping localStorage
        const originalCart = [...cart];
        cart = [];
        updateCartDisplay();

        // Now reload from localStorage
        loadCart();

        if (cart.length === originalCart.length) {
          result.innerHTML =
            '<p class="success">‚úÖ Cart persistence working! Items restored after "refresh".</p>';
        } else {
          result.innerHTML =
            '<p class="error">‚ùå Cart persistence failed. Items not restored.</p>';
        }
      }

      // Clear cart
      function clearCart() {
        cart = [];
        localStorage.removeItem('sandwich-shop-cart');
        updateCartDisplay();
        document.getElementById('clear-result').innerHTML =
          '<p class="success">‚úÖ Cart cleared from memory and localStorage.</p>';
      }

      // Inspect localStorage
      function inspectLocalStorage() {
        const inspection = document.getElementById('storage-inspection');
        try {
          const cartData = localStorage.getItem('sandwich-shop-cart');
          if (cartData) {
            const parsed = JSON.parse(cartData);
            inspection.innerHTML = `
                        <h4>localStorage Contents:</h4>
                        <pre style="background: #f8f9fa; padding: 10px; border-radius: 3px;">${JSON.stringify(parsed, null, 2)}</pre>
                    `;
          } else {
            inspection.innerHTML = '<p>No cart data in localStorage</p>';
          }
        } catch (error) {
          inspection.innerHTML = `<p class="error">Error reading localStorage: ${error.message}</p>`;
        }
      }

      // Load cart on page load
      window.addEventListener('load', loadCart);
    </script>
  </body>
</html>
